{% extends "admin/change_form.html" %}
{% load i18n admin_urls %}

{% block field_sets %}
    {% autoescape off %}
        <div class="body-preview" style="display: none">
            {{ adminform.form.instance.body }}
        </div>
    {% endautoescape %}

    {% for fieldset in adminform %}
      {% include "admin/includes/fieldset.html" %}
    {% endfor %}
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
    <link href = "https://fonts.googleapis.com/icon?family=Material+Icons" rel = "stylesheet">
    <style>
        .body-preview {
            border: 1px solid red;
            padding: 10px;
        }

        #toggle-preview {
            padding: 3px 6px;
        }

        #toggle-preview a {
            display: block;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #toggle-preview i {
            display: block;
            font-size: 20px;
        }
    </style>

    <script>
        let visibility = false;

        document.addEventListener("DOMContentLoaded", function() {
            const bodyPreviewElem = document.querySelector(".body-preview");
            {% if adminform.form.instance.is_markdown %}
                const converter = new showdown.Converter({});
                bodyPreviewElem.innerHTML = converter.makeHtml(bodyPreviewElem.innerHTML);
            {% endif %}


            document.querySelector(".form-row.field-body textarea[name='body']").addEventListener("input", function(evt) {
                let html = evt.target.value;
                {% if adminform.form.instance.is_markdown %}
                    html = converter.makeHtml(html);
                {% endif %}

                bodyPreviewElem.innerHTML = html;
                const codeBlocks = document.querySelectorAll("pre > code");
                for (let i = 0; i < codeBlocks.length; i++) {
                    hljs.highlightBlock(codeBlocks[i]);
                }
            });
        });

        function toggleVisibility(evt) {
            evt.preventDefault();
            visibility = !visibility;
            document.querySelector("#toggle-preview i.material-icons").textContent = visibility ? "visibility" : "visibility_off";
            document.querySelector(".body-preview").style.display = !visibility ? "none" : "block";
        }

        hljs.initHighlightingOnLoad();
    </script>
{% endblock %}


{% block object-tools-items %}
    <li>
        <a id="toggle-preview" href="" onclick="toggleVisibility(event)" class="historylink">
            <i class="material-icons">
                visibility_off
            </i>
        </a>
    </li>
    <li>
        <a href="{% url opts|admin_urlname:'history' original.pk|admin_urlquote %}" class="historylink">{% translate "History" %}</a>
    </li>
    {% if has_absolute_url %}
        <li>
            <a href="{% url 'admin:view_on_site' content_type_id original.pk %}" class="viewsitelink">{% translate "View on site" %}</a>
        </li>
    {% endif %}
{% endblock %}